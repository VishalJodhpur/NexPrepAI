<div *ngIf="!attemptId && !hasSavedProgress" class="start-screen">
  <div class="start-card">
    <h1>Ready to Start?</h1>
    <p>Click the button below to begin your exam.</p>
    <button class="btn btn-primary btn-lg" (click)="start()">
      <span class="material-icons-outlined">play_arrow</span>
      Start Exam
    </button>
  </div>
</div>

<div *ngIf="!attemptId && hasSavedProgress" class="resume-screen">
  <div class="start-card">
    <h1>Continue Your Exam</h1>
    <p>You have saved progress for this exam.</p>
    <div class="button-group">
      <button class="btn btn-primary btn-lg" (click)="resumeTest()">
        <span class="material-icons-outlined">play_arrow</span>
        Resume Exam
      </button>
      <button class="btn btn-secondary btn-lg" (click)="start()">
        <span class="material-icons-outlined">refresh</span>
        Start New Exam
      </button>
    </div>
  </div>
</div>

<div *ngIf="attemptId" class="exam-layout-container"> <!-- Added a wrapper class -->
  <div class="sidebar"> <!-- Sidebar Wrapper -->
    <div class="sidebar-header">
      <div class="exam-title">{{ testSeriesTitle }}</div>
      <div class="timer-display">
        <span class="material-icons-outlined timer-icon">timer</span>
        <span class="time-counter">{{ formatTime(timeLeft) }}</span>
      </div>
      <!-- Language Switcher -->
      <div class="language-switcher" *ngIf="currentQuestionDisplayData && currentQuestionDisplayData.availableLanguages && currentQuestionDisplayData.availableLanguages.length > 1">
        <button *ngIf="currentQuestionDisplayData.availableLanguages.includes('en')" (click)="changeLanguage('en')" [class.active]="currentLanguage === 'en'">English</button>
        <button *ngIf="currentQuestionDisplayData.availableLanguages.includes('hi')" (click)="changeLanguage('hi')" [class.active]="currentLanguage === 'hi'">हिंदी</button>
      </div>
    </div>

    <div class="section-navigator" #sectionNavigator>
      <div *ngFor="let section of sections; let sIdx = index" class="section-block">
        <div class="section-title">{{ section.title }}</div>
        <div class="question-palette">
          <button *ngFor="let q of section.questions; let qIdx = index"
                  (click)="goToQuestion(sIdx, qIdx)"
                  [attr.title]="'Question ' + getGlobalQuestionNumber(sIdx, qIdx)"
                  [ngClass]="{
                    'answered': getQuestionStatus(sIdx, qIdx) === 'answered',
                    'marked-for-review': getQuestionStatus(sIdx, qIdx) === 'marked-for-review',
                    'unanswered': getQuestionStatus(sIdx, qIdx) === 'unanswered',
                    'current-question-in-palette': isCurrentQuestion(sIdx, qIdx)
                  }"
                  class="question-palette-btn">
            {{ getGlobalQuestionNumber(sIdx, qIdx) }}
            <span *ngIf="isQuestionFlagged(sIdx, qIdx)" class="material-icons-outlined flag-icon">flag</span>
          </button>
        </div>
      </div>
    </div>

    <div class="palette-legend">
      <div class="legend-title">Legend</div>
      <div class="legend-item">
        <span class="legend-color-box unanswered-box"></span> Unanswered
      </div>
      <div class="legend-item">
        <span class="legend-color-box answered-box"></span> Answered
      </div>
      <div class="legend-item">
        <span class="legend-color-box marked-box"></span> Marked for Review
      </div>
      <div class="legend-item">
        <span class="legend-color-box current-box"></span> Current Question
      </div>
      <div class="legend-item">
        <span class="material-icons-outlined flag-icon-legend">flag</span> Flagged for Review
      </div>
    </div>

    <div class="sidebar-footer">
      <button class="btn btn-secondary btn-block mb-2" (click)="triggerManualSave()" [disabled]="!attemptId">
        <span class="material-icons-outlined">save</span>
        Save Progress
      </button>
      <button class="btn btn-danger btn-block global-submit-btn" (click)="submit()">
        <span class="material-icons-outlined">done_all</span> Submit Exam
      </button>
    </div>
  </div> <!-- End of Sidebar -->
  <div class="main-question-area"> <!-- Main Content Area for Question -->
    <p>Time left: {{ formatTime(timeLeft) }}</p> 
    
    <form [formGroup]="form" (ngSubmit)="submit()"> <!-- (ngSubmit) might be for Enter key, main submit is in sidebar -->
      <div formArrayName="responses">
        <ng-container *ngFor="let ctrl of responses.controls; let globalIdx = index">
          <!-- Display current question based on globalIdx matching currentGlobalQuestionIndex -->
          <div *ngIf="isCurrentQuestionByIndex(globalIdx) && currentQuestionDisplayData" [formGroupName]="globalIdx" class="question-display-container">
            <p class="question-text">
              Q{{ getGlobalQuestionNumber(currentSectionIndex, currentQuestionInSectionIndex) }}:
              {{ currentQuestionDisplayData.displayQuestionText }}
            </p>

            <div *ngIf="currentQuestionDisplayData.questionHistory && currentQuestionDisplayData.questionHistory.length > 0" class="question-history-display">
              <span *ngFor="let historyItem of currentQuestionDisplayData.questionHistory; let isLast = last">
                [{{ historyItem.title }} ({{ historyItem.askedAt | date:'yyyy' }})]<span *ngIf="!isLast">, </span>
              </span>
            </div>
            
            <div *ngIf="currentQuestionDisplayData.displayOptions && currentQuestionDisplayData.translations" class="question-images-options">
              <!-- Display Images for the current language -->
              <ng-container *ngFor="let translation of currentQuestionDisplayData.translations">
                <div *ngIf="translation.lang === currentLanguage">
                  <ng-container *ngIf="translation.images && translation.images.length > 0">
                    <div *ngFor="let imageUrl of translation.images" class="question-image-wrapper">
                      <img *ngIf="imageUrl" [src]="imageUrl" alt="Question Image" style="max-width: 100%; height: auto; margin-bottom: 10px;">
                    </div>
                  </ng-container>
                </div>
              </ng-container>
            
              <!-- Display Options for the current language -->
              <div *ngFor="let opt of currentQuestionDisplayData.displayOptions; let oi = index" class="option-item">
                <label>
                  <input
                    type="radio" 
                    formControlName="selected" 
                    [value]="oi.toString()" 
                  />
                  {{ opt.text }}
                  <img *ngIf="opt.img" [src]="opt.img" alt="Option Image" class="option-image" style="max-width: 200px; height: auto; margin-left: 10px;">
                </label>
              </div>
            </div>            <div class="question-actions">
              <div class="action-controls">
                <!-- REMOVED Mark for review checkbox -->
                
                <!-- Flag Toggle Button -->
                <button type="button" 
                        (click)="toggleQuestionFlag(currentGlobalQuestionIndex)" 
                        [ngClass]="{'flagged': isQuestionFlaggedByIndex(currentGlobalQuestionIndex)}"
                        class="flag-btn btn btn-outline-warning" 
                        title="Flag this question">
                  <span class="material-icons-outlined">{{isQuestionFlaggedByIndex(currentGlobalQuestionIndex) ? 'flag' : 'flag_outline'}}</span>
                  Flag
                </button>
                
                <!-- Confidence Rating -->
                <div class="confidence-rating">
                  <label>Confidence Level:</label>
                  <select formControlName="confidence" class="confidence-select">
                    <option value="">Select</option>
                    <option value="1">1 - Very Low</option>
                    <option value="2">2 - Low</option>
                    <option value="3">3 - Medium</option>
                    <option value="4">4 - High</option>
                    <option value="5">5 - Very High</option>
                  </select>
                </div>
              </div>
              
              <div class="navigation-buttons">
                <button type="button" (click)="prev()" [disabled]="isFirstQuestionOverall()" class="nav-btn prev-btn btn btn-secondary">
                  Prev
                </button>
                <button type="button" (click)="next()" [disabled]="isLastQuestionOverall()" class="nav-btn next-btn btn btn-primary">
                  Next
                </button>
              </div>
            </div>
          </div>
        </ng-container>
      </div>
    </form>
  </div> <!-- End of Main Question Area -->
</div>
