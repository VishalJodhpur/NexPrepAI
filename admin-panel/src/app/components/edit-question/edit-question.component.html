<h2>Edit Question</h2>
<form #form="ngForm" (ngSubmit)="save(form)">
  <!-- Question Text with validation -->
  <div>
    <label>Question:</label>
    <input
      type="text"
      name="questionText"
      [(ngModel)]="question.questionText"
      required
      #qt="ngModel"
    />
    <div *ngIf="qt.invalid && (qt.touched || form.submitted)" class="error">
      Question is required.
    </div>
  </div>

  <!-- Options -->
  <div *ngFor="let opt of question.options; let i = index">
    <label>Option {{ i + 1 }}:</label>
    <input
      type="text"
      [(ngModel)]="question.options[i].text"
      name="option{{i}}"
      required
    />
    <label>
      <input
        type="checkbox"
        [(ngModel)]="question.options[i].isCorrect"
        name="correct{{i}}"
      />
      Correct
    </label>
    <!-- Remove button -->
    <button type="button"
            (click)="removeOption(i)"
            [disabled]="question.options.length <= 2">
      Remove
    </button>
  </div>

  <!-- Add new option button -->
  <div>
    <button type="button" (click)="addOption()">
      + Add Option
    </button>
  </div>

  <!-- Difficulty -->
  <div>
    <label for="difficulty">Difficulty:</label>
    <select
      id="difficulty"
      name="difficulty"
      [(ngModel)]="question.difficulty"
      required
      #diff="ngModel"
    >
      <option value="">Select Difficulty</option>
      <option value="Easy">Easy</option>
      <option value="Medium">Medium</option>
      <option value="Hard">Hard</option>
    </select>
    <div *ngIf="diff.invalid && (diff.touched || form.submitted)" class="error">
      Difficulty is required.
    </div>
  </div>

  <!-- Branch Dropdown -->
  <div>
    <label for="branch">Branch:</label>
    <select
      id="branch"
      name="branch"
      [(ngModel)]="question.branch" 
      (change)="onBranchChange($any($event.target).value)" 
      required
      #branchCtrl="ngModel"
    >
      <option value="">Select Branch</option>
      <option *ngFor="let b of branches" [value]="b._id">{{ b.name }}</option>
    </select>
    <div *ngIf="branchCtrl.invalid && (branchCtrl.touched || form.submitted)" class="error">
      Branch is required.
    </div>
    <a routerLink="/branches/new">+ Add Branch</a>
  </div>

  <!-- Subject Dropdown -->
  <div>
    <label for="subject">Subject:</label>
    <select
      id="subject"
      name="subject"
      [(ngModel)]="question.subject"
      (change)="onSubjectChange($any($event.target).value)"
      [disabled]="!question.branch || subjects.length === 0"
      #subjectCtrl="ngModel"
    >
      <option value="">Select Subject</option>
      <option *ngFor="let s of subjects" [value]="s._id">{{ s.name }}</option>
    </select>
    <!-- Subject is not always required, so no error message for missing subject unless specified -->
  </div>

  <!-- Topic Dropdown -->
  <div>
    <label for="topic">Topic:</label>
    <select
      id="topic"
      name="topic"
      [(ngModel)]="question.topic"
      (change)="onTopicChange($any($event.target).value)"
      [disabled]="!question.subject || topics.length === 0"
      #topicCtrl="ngModel"
    >
      <option value="">Select Topic</option>
      <option *ngFor="let t of topics" [value]="t._id">{{ t.name }}</option>
    </select>
  </div>

  <!-- Subtopic Dropdown -->
  <div>
    <label for="subTopic">Subtopic:</label>
    <select
      id="subTopic" 
      name="subTopic"
      [(ngModel)]="question.subTopic"
      (change)="onSubtopicChange($any($event.target).value)" 
      [disabled]="!question.topic || subtopics.length === 0"
      #subtopicCtrl="ngModel"
    >
      <option value="">Select Subtopic</option>
      <option *ngFor="let st of subtopics" [value]="st._id">{{ st.name }}</option>
    </select>
  </div>

  <!-- Explanation (optional) -->
  <div>
    <label for="explanation">Explanation:</label>
    <textarea
      id="explanation"
      name="explanation"
      [(ngModel)]="question.explanation"
    ></textarea>
  </div>

  <!-- Save Button -->
  <div>
    <button type="submit" [disabled]="isLoading">
      {{ isLoading ? 'Saving...' : 'Save Changes' }}
    </button>
    <button type="button" (click)="cancel()">Cancel</button>
  </div>
</form>