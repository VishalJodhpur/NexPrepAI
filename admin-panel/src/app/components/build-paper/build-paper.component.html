<form [formGroup]="seriesForm" (ngSubmit)="onSubmit()">
  <h2>Build Paper</h2>

  <!-- Title -->
  <label>Title</label>
  <input formControlName="title" type="text" />

  <!-- Duration & Marks -->
  <label>Duration (min)</label>
  <input formControlName="duration" type="number" />

  <!-- Type -->
  <label>Type</label>
  <select formControlName="type">
    <option value="Real_Exam">Real Exam</option>
    <option value="Practice_Exam">Practice Exam</option>
    <option value="Live_Exam">Live Exam</option>
    <option value="Quiz_Exam">Quiz Exam</option>
  </select>

  <!-- Mode -->
  <div>
    <label for="mode">Mode:</label>
    <select id="mode" formControlName="mode">
      <option value="practice">Practice</option>
      <option value="live">Live</option>
    </select>
  </div>

  <label>Max Attempts</label>
  <input
    formControlName="maxAttempts"
    type="number"
    min="1"
    placeholder="How many tries?"
  />

  <label>Year</label>
  <input formControlName="year" type="number" min="1900" max="{{ currentYear }}" />

  <label>Start At</label>
  <input formControlName="startAt" type="datetime-local" />

  <label>End At</label>
  <input formControlName="endAt" type="datetime-local" />

  <div>
    <label for="randomizeSectionOrder">Randomize Section Order:</label>
    <input type="checkbox" id="randomizeSectionOrder" formControlName="randomizeSectionOrder">
  </div>

  <!-- Family -->
  <select #familySelect formControlName="family" (change)="onFamilyChange(familySelect.value)">
    <option value="">Select Family</option>
    <option *ngFor="let f of families" [value]="f._id">{{ f.name }}</option>
  </select>
  <p *ngIf="!families.length" class="empty-list-message">Families not available or list is empty.</p>

  <!-- Stream -->
  <select #streamSelect formControlName="stream" [disabled]="!streams.length" (change)="onStreamChange(streamSelect.value)">
    <option value="">Select Stream</option>
    <option *ngFor="let s of streams" [value]="s._id">{{ s.name }}</option>
  </select>
  <p *ngIf="seriesForm.get('family')?.value && !streams.length" class="empty-list-message">
    Streams not available for the selected family or list is empty.
  </p>

  <!-- Paper -->
  <select #paperSelect formControlName="paper" [disabled]="!papers.length" (change)="onPaperChange(paperSelect.value)">
    <option value="">Select Paper</option>
    <option *ngFor="let p of papers" [value]="p._id">
      {{ p.name }}<ng-container *ngIf="p.code"> ({{ p.code }})</ng-container>
    </option>
  </select>
  <p *ngIf="seriesForm.get('stream')?.value && !papers.length" class="empty-list-message">
    Papers not available for the selected stream or list is empty.
  </p>

  <!-- Shift/Variant -->
  <select #shiftSelect formControlName="shift" [disabled]="!shifts.length" (change)="onShiftChange(shiftSelect.value)">
    <option value="">Select Shift</option>
    <option *ngFor="let v of shifts" [value]="v._id">{{ v.name }}</option>
  </select>
  <p *ngIf="seriesForm.get('paper')?.value && !shifts.length" class="empty-list-message">
    Shifts not available for the selected paper or list is empty.
  </p>

  <!-- Sections -->
  <div formArrayName="sections">
    <div *ngFor="let secCtrl of sections.controls; let i = index" [formGroupName]="i">
      <h3>Section {{ i + 1 }}</h3>
      <label>Section Title</label>
      <input formControlName="title" type="text" />
      <label>Order</label>
      <input formControlName="order" type="number" />

      <div>
        <label for="randomizeQuestionOrderInSection-{{i}}">Randomize Question Order in Section:</label>
        <input type="checkbox" id="randomizeQuestionOrderInSection-{{i}}" formControlName="randomizeQuestionOrderInSection">
      </div>

      <div>
        <label for="questionsToSelectFromPool-{{i}}">Number of Questions to Select from Pool:</label>
        <input type="number" id="questionsToSelectFromPool-{{i}}" formControlName="questionsToSelectFromPool" min="0">
      </div>

      <div>
        <label for="questionPool-{{i}}">Question Pool (comma-separated IDs):</label>
        <textarea id="questionPool-{{i}}" formControlName="questionPool" rows="3" placeholder="Enter question IDs, separated by commas"></textarea>
      </div>

      <!-- ADDED: Inputs for default marks for pooled questions -->
      <div *ngIf="secCtrl.get('questionsToSelectFromPool')?.value > 0">
        <label for="defaultMarksForPooledQuestion-{{i}}">Default Marks for Pooled Questions:</label>
        <input type="number" id="defaultMarksForPooledQuestion-{{i}}" formControlName="defaultMarksForPooledQuestion" min="0">
      </div>

      <div *ngIf="secCtrl.get('questionsToSelectFromPool')?.value > 0">
        <label for="defaultNegativeMarksForPooledQuestion-{{i}}">Default Negative Marks for Pooled Questions:</label>
        <input type="number" id="defaultNegativeMarksForPooledQuestion-{{i}}" formControlName="defaultNegativeMarksForPooledQuestion" min="0" step="0.25">
      </div>
      <!-- End of ADDED section -->

      <!-- Question selection -->
      <div formArrayName="questions">
        <!-- ADDED: Search input and results display -->
        <div>
          <label>Search Question by Text:</label>
          <input
            type="text"
            [(ngModel)]="sectionSearchTerms[i]"
            (ngModelChange)="performSearch(i)"
            [ngModelOptions]="{standalone: true}"
            placeholder="Type to search..."
          />
          <div *ngIf="sectionSearchResults[i] && sectionSearchResults[i].length > 0" class="search-results-container mt-2">
            <h6>Search Results:</h6>
            <ul class="list-group search-results-list">
              <li *ngFor="let q of sectionSearchResults[i]" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                <span [innerHTML]="(q.translations[0].questionText || q.questionText || 'Test Question Text Missing') | highlight:sectionSearchTerms[i]"></span>
                <button type="button" class="btn btn-sm btn-outline-success" (click)="addQuestionFromSearchResults(i, q)">Add</button>
              </li>
            </ul>
          </div>
          <div *ngIf="sectionSearchTerms[i] && sectionSearchTerms[i].length > 2 && (!sectionSearchResults[i] || sectionSearchResults[i].length === 0)">
            No questions found matching your search.
          </div>
        </div>
        <!-- End of ADDED section -->

        <div *ngFor="let qCtrl of getQuestions(i).controls; let j = index" [formGroupName]="j">
          <label>Question {{ j+1 }} ‚Äì ID</label>
          <input
            type="text"
            formControlName="question"
            placeholder="Paste question _id"
          />
          <button type="button" (click)="previewQuestion(i, j)">
            üîç Preview
          </button>
          <!-- MODIFIED: Display logic for preview of an added question -->
          <div *ngIf="previewedQuestions[i] && previewedQuestions[i][j]" class="preview">
            {{ previewedQuestions[i][j]?.translations[0]?.questionText || previewedQuestions[i][j]?.questionText || 'Text not available' }}
          </div>

          <input formControlName="marks" type="number" min="1" required placeholder="Marks" />
          <input
            formControlName="negativeMarks"
            type="number"
            min="0"
            step="0.25"
            placeholder="Negative Marks"
          />
          <button type="button" (click)="removeQuestion(i,j)">Remove Question</button>
        </div>
        <input
          type="file"
          (change)="importCsv($event, i)"
          accept=".csv"
        />
        <button type="button" (click)="addQuestion(i)">+ Add Question</button>
      </div>

      <button type="button" (click)="removeSection(i)">Remove Section</button>
    </div>
  </div>
  <button type="button" (click)="addSection()">+ Add Section</button>

  <p><strong>Total Marks:</strong> {{ computedTotal }}</p>

  <button type="submit" [disabled]="seriesForm.invalid">Create Test Series</button>
</form>
